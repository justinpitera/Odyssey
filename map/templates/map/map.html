{% load static %}
<!DOCTYPE html>
<html>
    <head>
        <!-- Meta tags for mobile -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="apple-mobile-web-app-title" content="Odyssey">
        <link rel="apple-touch-icon" href="static/images/favicon.ico">

        <link rel="stylesheet" href="{% static 'map/css/styles.css' %}">
        <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet' />
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{page_title}}</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/gh/eliyantosarage/font-awesome-pro@main/fontawesome-pro-6.5.1-web/css/all.min.css" rel="stylesheet">
        <link rel="shortcut icon" type="image/png" href="{% static 'images/favicon.ico' %}" >
    </head>
    <body data-user-id="{{user.id}}">
        <div id="loading-screen"></div>
        <script>
            window.addEventListener('load', function() {
                const loadingScreen = document.getElementById('loading-screen');
                if(loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
            });
        </script>
        

        <div id="search-bar" style="position: absolute; top: 50px; left: 50%; transform: translateX(-50%); z-index: 1000;">
            <input type="text" placeholder="Search..." id="search-input" style="padding: 10px 10px 10px 40px; width: 400px; border-radius: 20px;">
            <i class="fas fa-search" style="position: absolute; top: 15px; left: 10px; color: #aaa;"></i>
            <i class="fas fa-times" id="clear-input" style="position: absolute; top: 15px; right: 10px; color: #aaa; cursor: pointer;"></i>
            <div id="search-results" style="display: none; position: absolute; top: 105px; left: 50%; transform: translateX(-50%); background-color: white; border: 1px solid #aaa; border-radius: 5px; width: 400px; max-height: 300px; overflow-y: auto; z-index: 1001;"></div>
        </div>
        <script>
            const placeholders = [
                "Search for airports...",
                "Search for helipads...",
                "Search for waypoints...",
                "Search by flight number...",
                "Search by username...",
                "Search by aircraft type...",
                "Search by frequency...",
                "Search by tower name...",
                "Search by VATSIM CID...",
            ];
        
            const searchInput = document.getElementById("search-input");
        
            function animatePlaceholder() {
                const randomIndex = Math.floor(Math.random() * placeholders.length);
                searchInput.placeholder = placeholders[randomIndex];
                setTimeout(animatePlaceholder, 3000); // Change every 3 seconds
            }
        
            animatePlaceholder(); // Start the animation
        </script>
        
        <div id="airport-card" style="display: none; position: absolute; top: 40%; left: 10%; transform: translateY(-50%); z-index: 1000;" class="max-w-2xl mx-auto bg-white rounded-lg border border-gray-200 shadow-md dark:bg-gray-800 dark:border-gray-700 z-50">
            <div class="draggable-handle flex justify-between items-center p-2 cursor-move">
                <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Airport Name</h5>
                <button id="close-card-btn" class="text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <!-- Tabs -->
            <ul id="tabs" class="flex flex-wrap -mb-px text-sm font-medium text-center text-gray-500 border-b border-gray-200 dark:border-gray-700">
                <li class="mr-2">
                    <a href="#" class="inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" onclick="changeTab('details')">Airport Details</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" onclick="changeTab('arrivals')">Arrivals</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" onclick="changeTab('departures')">Departures</a>
                </li>

            </ul>
            
            <!-- Tab Contents -->
            <div id="tabContents">
                <div id="details" class="hidden p-4">
                    <p class="text-gray-700 dark:text-gray-400">Airport Details content...</p>
                </div>
                <div id="arrivals" class="hidden p-4">
                    <p class="text-gray-700 dark:text-gray-400">Arrivals content...</p>
                </div>
                <div id="departures" class="hidden p-4">
                    <p class="text-gray-700 dark:text-gray-400">Departures content...</p>
                </div>

            </div>
            </div>
        </div>
    

        
        <!-- Map toolbar -->
        <div id="map-toolbar" style="position: absolute; bottom: 25px; right: 20px; z-index: 1000; display: flex;">
            <select id="styleSelector">
                <option value="mapbox://styles/mapbox/streets-v11">Streets</option>
                <option value="mapbox://styles/mapbox/outdoors-v11">Outdoors</option>
                <option value="mapbox://styles/mapbox/light-v10">Light</option>
                <option value="mapbox://styles/mapbox/dark-v10" selected>Dark</option>
                <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
                <option value="mapbox://styles/mapbox/satellite-streets-v11">Satellite Streets</option>
            </select>
            <button id="toggle-rotation" class="toolbar-btn">
            <i class="fa-solid fa-magnifying-glass-arrows-rotate"></i>
            </button>
            <button class="toolbar-btn">
            <i class="fa-solid fa-layer-group"></i>
            </button>
            <button id="filters-btn" class="toolbar-btn">
            <i class="fas fa-filter"></i>
            </button>
        </div>
        <div id="map"></div>
        <div style="position: absolute; top: 10px; left: 10px; z-index: 1000;">
            <a href="{% url 'map' %}" style="margin-left: 5px; color: white; text-shadow: 3px 3px 5px rgba(0,0,0,0.5);">Odyssey Network</a>
        </div>



        
        
        
        <script>
            mapboxgl.accessToken = 'pk.eyJ1Ijoib2R5c3NleWNsaWVudCIsImEiOiJjbHQ2MGh2NDMwNmE2MnJvZXhwdWIwZmJpIn0._1PC-pg9OaMJldN9svTWwg';
            const map = new mapboxgl.Map({
                container: 'map', // container ID
                style: 'mapbox://styles/mapbox/dark-v11', // Initial map style
                center: [0, 0], // Starting position
                zoom: 1, // Starting zoom
                projection: 'globe' // Enable the globe projection
            });

            map.addControl(new mapboxgl.NavigationControl());
            map.on('load', () => {
                // Initial setting of terrain
                map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });

                // Add fog to create a misty effect, especially at higher altitudes or distances
                map.setFog({
                    'range': [0, 1.5],
                    'color': '#4e4e52', // Adjust the color to fit the dark theme
                    'horizon-blend': 0.04,
                });

                // Set light to simulate a moonlight or low-light condition for a darker sky effect
                map.setLight({
                    'anchor': 'viewport',
                    'color': '#8899AA',
                    'intensity': 0.3
                });

                // Add or adjust the atmosphere to create a more immersive globe projection experience
                if (!map.getAtmosphere()) { // Check if the atmosphere is not already set
                    map.setAtmosphere({
                        'skyType': 'atmosphere',
                        'skyAtmosphereColor': '#000000',
                        'skyAtmosphereSun': [0.0, 0.0],
                        'skyAtmosphereSunIntensity': 15
                    });
                }
            });

            document.getElementById('styleSelector').addEventListener('change', function() {
                var selectedStyle = this.value;
                map.setStyle(selectedStyle);

                // Because setStyle will remove and re-add all layers/sources, wait for the style to load before re-adding them
                map.once('style.load', () => {
                    // Ensure this function can handle being called multiple times
                    drawWaypointsAndRoute();
                    startImage();
                    // Reapply fog, light, and atmosphere settings since setStyle removes them
                    map.setFog({
                        'range': [0, 1.5],
                        'color': '#4e4e52',
                        'horizon-blend': 0.04,
                    });

                    map.setLight({
                        'anchor': 'viewport',
                        'color': '#8899AA',
                        'intensity': 0.3
                    });

                    if (!map.getAtmosphere()) {
                        map.setAtmosphere({
                            'skyType': 'atmosphere',
                            'skyAtmosphereColor': '#000000',
                            'skyAtmosphereSun': [0.0, 0.0],
                            'skyAtmosphereSunIntensity': 15
                        });
                    }
                });

            });
        </script>
        <script src="{% static 'map/js/airports.js' %}"></script>
        <script src="{% static 'map/js/aircraft.js' %}"></script>
        <script src="{% static 'map/js/waypoints.js' %}"></script>
        <script src="{% static 'map/js/search.js' %}"></script>
        <script src="{% static 'map/js/window.js' %}"></script>
        <script src="{% static 'map/js/vatsim.js' %}"></script>
        <script src="{% static 'map/js/control.js' %}"></script>
        <script src="{% static 'map/js/cardControl.js' %}"></script>
        <script>
        /**
        * Main function to draw waypoints and route.
        */
        function drawWaypointsAndRoute() {
            const simBriefApiUrl = 'https://www.simbrief.com/api/xml.fetcher.php?userid={{user.simbrief_id}}&json=1'; 

            fetchFlightPlanData(simBriefApiUrl)
                .then(processAndDrawRoute)
                .catch(error => console.error('Failed to draw waypoints and route:', error));
        }

        drawWaypointsAndRoute();
        </script>
    </body>
</html>
